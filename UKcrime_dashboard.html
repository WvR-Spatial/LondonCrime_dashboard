<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrimeEye: UK Police API Live</title>
    
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; overflow: hidden; background: #1a1a1a; }
        
        #sidebar {
            width: 320px;
            background: #1e1e1e;
            color: #e0e0e0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
            z-index: 2;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }
        #map { flex-grow: 1; position: relative; }
        
        h1 { font-size: 20px; color: #00bcd4; margin: 0 0 5px 0; letter-spacing: 1px; }
        h2 { font-size: 13px; color: #888; margin-bottom: 25px; font-weight: normal; }
        
        .stat-card {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 3px solid #00bcd4;
        }
        .stat-value { font-size: 24px; font-weight: bold; color: white; }
        .stat-label { font-size: 11px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Date Picker Styling */
        .control-group { margin-bottom: 20px; }
        label { display: block; font-size: 11px; color: #aaa; margin-bottom: 5px; text-transform: uppercase; }
        input[type="month"] {
            width: 100%;
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
        }

        .chart-container {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 6px;
            margin-top: auto; 
            height: 200px;
        }

        .source-link {
            font-size: 10px;
            color: #666;
            margin-top: 15px;
            text-align: center;
            border-top: 1px solid #333;
            padding-top: 10px;
        }
        .source-link a { color: #00bcd4; text-decoration: none; }

        /* Floating Status Messages */
        #status-msg {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.9); color: #fff; 
            padding: 10px 20px; border-radius: 4px; font-size: 12px;
            z-index: 100; border: 1px solid #444;
            display: none;
        }
        .error { border-color: #e91e63 !important; color: #ff80ab !important; }
        .success { border-color: #00bcd4 !important; color: #00bcd4 !important; }
    </style>
</head>
<body>

<div id="status-msg">Ready</div>

<div id="sidebar">
    <h1>CrimeEye Live</h1>
    <h2>UK Police API Integration</h2>
    
    <div class="control-group">
        <label for="date-selector">Data Period (YYYY-MM)</label>
        <input type="month" id="date-selector" onchange="forceRefresh()">
    </div>

    <div class="stat-card">
        <div class="stat-value" id="crime-count">-</div>
        <div class="stat-label">Total Crimes in View</div>
    </div>
    
    <div class="stat-card" style="border-color: #e91e63;">
        <div class="stat-value" id="hex-density">-</div>
        <div class="stat-label">Crimes in Selected Hex</div>
    </div>

    <div class="chart-container">
        <canvas id="crimeChart"></canvas>
    </div>

    <div class="source-link">
        Data Source: <a href="https://data.police.uk/docs/method/crime-street/" target="_blank">UK Police API</a><br>
        (Contains public sector information licensed under the Open Government Licence v3.0)
    </div>
</div>

<div id="map"></div>

<script>
    // --- 1. SETUP CHART ---
    // We need a larger palette because real data has 14+ categories
    const categoryColors = {
        'anti-social-behaviour': '#ffeb3b',
        'burglary': '#e91e63',
        'drugs': '#9c27b0',
        'public-order': '#ff9800',
        'violent-crime': '#f44336',
        'vehicle-crime': '#03a9f4',
        'other-theft': '#8bc34a',
        'shoplifting': '#00bcd4',
        'robbery': '#795548',
        'criminal-damage-arson': '#607d8b',
        'other': '#9e9e9e'
    };
    
    const ctx = document.getElementById('crimeChart').getContext('2d');
    let crimeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Incidents',
                data: [],
                backgroundColor: '#00bcd4',
                borderRadius: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#888' } },
                x: { ticks: { color: '#888', font: { size: 9 }, display: false } } // Hide labels to save space
            }
        }
    });

    // --- 2. SETUP MAP ---
    const map = new maplibregl.Map({
        container: 'map',
        style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
        center: [-0.1276, 51.5074], // London
        zoom: 13,
        minZoom: 9 // Restrict zoom to prevent crashing
    });

    // --- 3. API HANDLING ---
    
    // Set default date to 2 months ago (Police data always lags by ~1-2 months)
    const today = new Date();
    today.setMonth(today.getMonth() - 2);
    const defaultDate = today.toISOString().slice(0, 7); // YYYY-MM
    document.getElementById('date-selector').value = defaultDate;

    let debounceTimer;

    function showStatus(msg, type = 'normal') {
        const el = document.getElementById('status-msg');
        el.innerText = msg;
        el.style.display = 'block';
        el.className = type === 'error' ? 'error' : 'success';
    }

    // Function to generate Polygon String for API
    function getPolyString() {
        const bounds = map.getBounds();
        // Create a simple box: NW, NE, SE, SW
        const nw = bounds.getNorthWest();
        const ne = bounds.getNorthEast();
        const se = bounds.getSouthEast();
        const sw = bounds.getSouthWest();
        
        // Format: lat,lng:lat,lng:lat,lng:lat,lng
        return `${nw.lat},${nw.lng}:${ne.lat},${ne.lng}:${se.lat},${se.lng}:${sw.lat},${sw.lng}`;
    }

    async function fetchCrimeData() {
        const zoom = map.getZoom();
        
        // SAFEGUARD: API Limit Check
        // If zoom is too far out, the area is too big and will hit the 10k crime limit (503 error)
        if (zoom < 11) {
            showStatus("⚠️ Zoom in to load data (Area too large)", "error");
            return null;
        }

        showStatus("Fetching from UK Police API...", "normal");
        
        const date = document.getElementById('date-selector').value;
        const poly = getPolyString();
        
        // Construct API URL
        const url = `https://data.police.uk/api/crimes-street/all-crime?poly=${poly}&date=${date}`;

        try {
            const response = await fetch(url);
            
            if (response.status === 503) {
                throw new Error("Too many crimes in view (>10,000). Zoom in further.");
            }
            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }

            const data = await response.json();
            showStatus(`Loaded ${data.length} records for ${date}`, "success");
            
            // Convert to GeoJSON
            return {
                type: "FeatureCollection",
                features: data.map((crime, index) => ({
                    type: "Feature",
                    id: index, // Needed for feature-state
                    geometry: {
                        type: "Point",
                        coordinates: [parseFloat(crime.location.longitude), parseFloat(crime.location.latitude)]
                    },
                    properties: {
                        category: crime.category,
                        id: crime.id
                    }
                }))
            };

        } catch (err) {
            showStatus(err.message, "error");
            console.error(err);
            return null;
        }
    }

    // --- 4. CORE LOGIC (Resampling & Analysis) ---
    
    async function updateGrid() {
        const crimeGeoJSON = await fetchCrimeData();
        
        // If API failed or refused, stop here
        if (!crimeGeoJSON) return; 

        document.getElementById('crime-count').innerText = crimeGeoJSON.features.length.toLocaleString();

        // 1. Grid Resolution Logic
        const zoom = map.getZoom();
        let hexRadius = zoom < 12 ? 1.0 : (zoom < 13.5 ? 0.5 : 0.2); // km

        // 2. Generate Grid
        const bounds = map.getBounds();
        const bbox = [bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth()];
        const hexGrid = turf.hexGrid(bbox, hexRadius, {units: 'kilometers'});

        // 3. Spatial Join (Analysis)
        const aggregated = turf.collect(hexGrid, crimeGeoJSON, 'category', 'crime_types');

        // 4. Filter empty hexes
        const activeHexes = [];
        turf.featureEach(aggregated, (feature, index) => {
            const count = feature.properties.crime_types.length;
            if (count > 0) {
                feature.properties.density = count;
                feature.id = index;
                activeHexes.push(feature);
            }
        });

        const finalData = { type: "FeatureCollection", features: activeHexes };
        
        // 5. Render to Map
        if (map.getSource('hexagons')) {
            map.getSource('hexagons').setData(finalData);
        } else {
            map.addSource('hexagons', { type: 'geojson', data: finalData });
            
            map.addLayer({
                id: 'hex-fill',
                type: 'fill',
                source: 'hexagons',
                paint: {
                    'fill-color': [
                        'interpolate', ['linear'], ['get', 'density'],
                        0, '#2c3e50',
                        10, '#00bcd4', 
                        50, '#e91e63'
                    ],
                    'fill-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 0.8, 0.5]
                }
            });

            map.addLayer({
                id: 'hex-line',
                type: 'line',
                source: 'hexagons',
                paint: { 'line-color': '#00bcd4', 'line-width': 1 }
            });
        }
    }

    function forceRefresh() {
        updateGrid();
    }

    map.on('load', () => {
        updateGrid(); // Initial Load

        let hoveredId = null;

        // Interaction: Hover
        map.on('mousemove', 'hex-fill', (e) => {
            if (e.features.length > 0) {
                const feature = e.features[0];
                if (hoveredId !== null) map.setFeatureState({source: 'hexagons', id: hoveredId}, {hover: false});
                hoveredId = feature.id;
                map.setFeatureState({source: 'hexagons', id: hoveredId}, {hover: true});
                map.getCanvas().style.cursor = 'pointer';

                // Dashboard Update
                document.getElementById('hex-density').innerText = feature.properties.density;
                
                // Chart Update
                let crimeTypes = [];
                try { crimeTypes = JSON.parse(feature.properties.crime_types); } 
                catch(e) { crimeTypes = feature.properties.crime_types || []; }
                
                const counts = {};
                crimeTypes.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
                
                crimeChart.data.labels = Object.keys(counts);
                crimeChart.data.datasets[0].data = Object.values(counts);
                // Dynamic Coloring based on category
                crimeChart.data.datasets[0].backgroundColor = Object.keys(counts).map(cat => categoryColors[cat] || '#999');
                crimeChart.update();
            }
        });

        map.on('mouseleave', 'hex-fill', () => {
            if (hoveredId !== null) map.setFeatureState({source: 'hexagons', id: hoveredId}, {hover: false});
            hoveredId = null;
            map.getCanvas().style.cursor = '';
            document.getElementById('hex-density').innerText = '-';
        });

        // Trigger update when map movement ends
        map.on('moveend', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updateGrid, 500); // 500ms delay to be kind to the API
        });
    });
</script>
</body>
</html>
